<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š å€å¡Šéˆç€è¦½å™¨</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            background-color: #DCDCDC;
        }

        footer {
            background-color: #333;
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .navbar {
            background-color: #333;
            padding: 1rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-container {
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-logo {
            color: white;
            font-size: 1.5rem;
            text-decoration: none;
            font-weight: bold;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .nav-links a:hover {
            background-color: #555;
        }
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-links {
                flex-direction: row;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="#" class="nav-logo">å€å¡Šéˆç€è¦½å™¨</a>
            <div class="nav-links">
                <a href="home.html">é¦–é </a>
                <a href="dID.html">æ„Ÿæ‡‰å¡ç‰‡</a>
                <a href="issue.html">æ†‘è­‰ç”Ÿæˆ</a>
                <a href="blockscan.html">å€å¡Šéˆ</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4">
        <!-- çµ±è¨ˆè³‡è¨Š -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                <h3 class="text-gray-500 text-sm mb-1 flex items-center">
                    â±ï¸ ä¸‹ä¸€å€å¡Šå€’æ•¸
                </h3>
                <p class="text-3xl font-bold text-indigo-600" id="countdown">5ç§’</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                <h3 class="text-gray-500 text-sm mb-1 flex items-center">
                    ğŸ”— ç¸½å€å¡Šæ•¸
                </h3>
                <p class="text-3xl font-bold text-indigo-600" id="totalBlocks">-</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                <h3 class="text-gray-500 text-sm mb-1 flex items-center">
                    ğŸ“œ å¾…è™•ç†æ†‘è­‰
                </h3>
                <p class="text-3xl font-bold text-indigo-600" id="pendingCerts">-</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                <h3 class="text-gray-500 text-sm mb-1 flex items-center">
                    ğŸ‘¥ æ´»èºç¯€é»
                </h3>
                <p class="text-3xl font-bold text-indigo-600" id="activeNodes">-</p>
            </div>
        </div>

        <!-- æœå°‹å€åŸŸ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold mb-3 flex items-center">
                    ğŸ” æœå°‹å€å¡Š
                </h3>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="blockSearch" placeholder="è¼¸å…¥å€å¡Šç·¨è™Ÿ" 
                           class="w-full sm:flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button onclick="searchBlock()" 
                            class="w-full sm:w-auto bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        æœå°‹
                    </button>
                </div>
                <div id="blockResult" class="mt-4 break-all"></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold mb-3 flex items-center">
                    ğŸ” æœå°‹æ†‘è­‰
                </h3>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="certSearch" placeholder="è¼¸å…¥æ†‘è­‰ID" 
                           class="w-full sm:flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button onclick="searchCertificate()" 
                            class="w-full sm:w-auto bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        æœå°‹
                    </button>
                </div>
                <div id="certResult" class="mt-4 break-all"></div>
            </div>
        </div>

        <!-- æœ€æ–°å€å¡Šå’Œåœ–è¡¨ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold mb-4 flex items-center">ğŸ”— æœ€æ–°å€å¡Š</h3>
                <div id="latestBlocks" class="space-y-2"></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold mb-4 flex items-center">ğŸ“Š æ¯å€å¡Šæ†‘è­‰æ•¸é‡</h3>
                <canvas id="blockChart"></canvas>
            </div>
        </div>

        <!-- å€å¡Šè©³æƒ…å½ˆçª— -->
        <div id="blockModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">ğŸ”— å€å¡Šè©³æƒ…</h3>
                    <button onclick="closeBlockModal()" class="text-2xl">&times;</button>
                </div>
                <div id="blockModalContent" class="break-all"></div>
            </div>
        </div>
    </div>
    <footer>
        <p>&copy; 2024 æ•¸ä½èº«åˆ†è­‰ç³»çµ±. demoé‡ç¾</p>
    </footer>

    <script>
        let countdown = 5;
        let blockChart;

        async function fetchData() {
            try {
                const [statusRes, blocksRes, nodesRes] = await Promise.all([
                    fetch('https://xxxxxxx.ngrok.app/api/blockchain/status'),
                    fetch('https://xxxxxxx.ngrok.app/api/blockchain/blocks'),
                    fetch('https://xxxxxxx.ngrok.app/node/list')
                ]);

                const status = await statusRes.json();
                const blocks = await blocksRes.json();
                const nodes = await nodesRes.json();

                updateDashboard(status, blocks, nodes);
            } catch (error) {
                console.error('éŒ¯èª¤:', error);
            }
        }

        function updateDashboard(status, blocksData, nodes) {
            document.getElementById('totalBlocks').textContent = status.total_blocks;
            document.getElementById('pendingCerts').textContent = status.pending_certificates;
            document.getElementById('activeNodes').textContent = Object.keys(nodes.nodes || {}).length;

            const blocksHtml = blocksData.blocks.map(block => `
                <div class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer" 
                     onclick="showBlockDetails(${block.id})">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-indigo-600">å€å¡Š #${block.id}</span>
                        <span class="text-sm text-gray-600">
                            ${new Date(block.timestamp * 1000).toLocaleString()}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1 break-all">
                        é›œæ¹Šå€¼: ${block.hash.substring(0, 16)}...
                    </div>
                    <div class="text-sm mt-1">
                        ğŸ“œ ${block.certificates} å€‹æ†‘è­‰
                    </div>
                </div>
            `).join('');
            document.getElementById('latestBlocks').innerHTML = blocksHtml;

            updateChart(blocksData.blocks);
        }

        function updateChart(blocks) {
            const ctx = document.getElementById('blockChart');
            if (blockChart) {
                blockChart.destroy();
            }
            blockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: blocks.map(b => `å€å¡Š ${b.id}`),
                    datasets: [{
                        label: 'æ†‘è­‰æ•¸é‡',
                        data: blocks.map(b => b.certificates),
                        backgroundColor: '#4f46e5'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function showBlockDetails(blockId) {
            try {
                const response = await fetch(`https://xxxxxxx.ngrok.app/api/block/${blockId}`);
                const data = await response.json();
                
                const certificatesHtml = data.certificates.map(cert => `
                    <div class="bg-gray-50 p-4 rounded-lg mb-2">
                        <p class="font-medium">ğŸ“„ æ†‘è­‰ID: <span class="text-indigo-600 break-all">${cert.id}</span></p>
                        <p>ğŸ‘¤ æŒæœ‰è€…: ${cert.holder}</p>
                        <p>ğŸ“‹ é¡å‹: ${cert.type}</p>
                        <p>âœï¸ ç™¼è¡Œè€…: ${cert.issuer}</p>
                        <p>ğŸ“… ç™¼è¡Œæ—¥æœŸ: ${new Date(cert.issue_date).toLocaleString()}</p>
                        <p>â³ åˆ°æœŸæ—¥æœŸ: ${new Date(cert.expiry_date).toLocaleString()}</p>
                        <p>ğŸ“ å…ƒæ•¸æ“š: ${JSON.stringify(cert.metadata)}</p>
                    </div>
                `).join('');

                document.getElementById('blockModalContent').innerHTML = `
                    <div class="space-y-4">
                        <div class="border-b pb-4">
                            <p class="text-xl font-bold text-indigo-600">å€å¡Š #${data.index}</p>
                            <p class="text-sm mt-2"><strong>é›œæ¹Šå€¼:</strong> 
                                <span class="break-all">${data.hash}</span>
                            </p>
                            <p class="text-sm mt-2"><strong>å‰ä¸€å€å¡Šé›œæ¹Šå€¼:</strong> 
                                <span class="break-all">${data.previous_hash}</span>
                            </p>
                            <p class="text-sm mt-2"><strong>æ™‚é–“æˆ³è¨˜:</strong> 
                                ${new Date(data.timestamp * 1000).toLocaleString()}
                            </p>
                            <p class="text-sm mt-2"><strong>ç¢ºèªè€…:</strong> ${data.confirmations.join(', ')}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-bold mb-3">ğŸ“œ æ­¤å€å¡Šä¸­çš„æ†‘è­‰ (${data.certificates.length})</h4>
                            ${certificatesHtml}
                        </div>
                    </div>
                `;
                document.getElementById('blockModal').classList.remove('hidden');
            } catch (error) {
                alert('è¼‰å…¥å€å¡Šè©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        function closeBlockModal() {
            document.getElementById('blockModal').classList.add('hidden');
        }

        async function searchBlock() {
            const blockId = document.getElementById('blockSearch').value;
            try {
                const response = await fetch(`https://xxxxxxx.ngrok.app/api/block/${blockId}`);
                const data = await response.json();
                const html = `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="font-medium text-indigo-600">å€å¡Š #${data.index}</p>
                        <p class="text-sm mt-1 break-all">é›œæ¹Šå€¼: ${data.hash}</p>
                        <p class="text-sm break-all">å‰ä¸€å€å¡Šé›œæ¹Šå€¼: ${data.previous_hash}</p>
                        <p class="text-sm">æ™‚é–“: ${new Date(data.timestamp * 1000).toLocaleString()}</p>
                        <p class="text-sm">ğŸ“œ æ†‘è­‰æ•¸é‡: ${data.certificates.length}</p>
                        <p class="text-sm">âœ… ç¢ºèªè€…: ${data.confirmations.join(', ')}</p>
                    </div>
                `;
                document.getElementById('blockResult').innerHTML = html;
            } catch (error) {
                document.getElementById('blockResult').innerHTML = 
                    '<p class="text-red-500">âŒ æ‰¾ä¸åˆ°å€å¡Š</p>';
            }
        }

        async function searchCertificate() {
            const certId = document.getElementById('certSearch').value;
            try {
                const response = await fetch(`https://xxxxxxx.ngrok.app/api/certificate/${certId}`);
                const data = await response.json();
                const html = `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p><strong>ğŸ“„ æ†‘è­‰ID:</strong> <span class="break-all">${data.certificate.id}</span></p>
                        <p><strong>ğŸ‘¤ æŒæœ‰è€…:</strong> ${data.certificate.holder}</p>
                        <p><strong>ğŸ“‹ é¡å‹:</strong> ${data.certificate.type}</p>
                        <p><strong>ğŸ”— æ‰€åœ¨å€å¡Š:</strong> ${data.block}</p>
                        <p><strong>âœï¸ ç™¼è¡Œè€…:</strong> ${data.issuer}</p>
                        <p><strong>ğŸ“‘ æŒæœ‰è€…çš„å…¶ä»–æ†‘è­‰:</strong></p>
                        <div class="pl-4 break-all">
                            ${data.other_holder_certificates.length ? 
                                data.other_holder_certificates.join(',<br>') : 'ç„¡'}
                        </div>
                    </div>
                `;
                document.getElementById('certResult').innerHTML = html;
            } catch (error) {
                document.getElementById('certResult').innerHTML = 
                    '<p class="text-red-500">âŒ æ‰¾ä¸åˆ°æ†‘è­‰</p>';
            }
        }

        setInterval(() => {
            countdown--;
            if (countdown <= 0) {
                countdown = 5;
                fetchData();
            }
            document.getElementById('countdown').textContent = countdown + 'ç§’';
        }, 1000);

        window.onclick = function(event) {
            const modal = document.getElementById('blockModal');
            if (event.target == modal) {
                closeBlockModal();
            }
        }

        fetchData();
    </script>
</body>
</html>